<script>
    var map;
    var otherListingsMap;
    var infowindow;
    var panorama;

    function initMap() {
        initSurroundingsMap();
        initOtherListingsMap();
        initStreetView();
    }

    function initOtherListingsMap() {
        let listingLocation = {lat: <%= @listing.latitude %>, lng: <%= @listing.longitude %>};

        otherListingsMap = new google.maps.Map(document.getElementById('detail-map'), {
            center: listingLocation,
            zoom: 17,
            streetViewControl: false
        });

        infowindow = new google.maps.InfoWindow();

        createMarkerFromLatLong(otherListingsMap, listingLocation);

        $("body").on("shown.bs.tab", "#map-tab", function () {
            google.maps.event.trigger(otherListingsMap, 'resize');
        });
    }

    function initSurroundingsMap() {
        let listingLocation = {lat: <%= @listing.latitude %>, lng: <%= @listing.longitude %>};

        map = new google.maps.Map(document.getElementById('surroundings-map'), {
            center: listingLocation,
            zoom: 17,
            mapTypeControl: false,
            streetViewControl: false
        });

        createMarkerFromLatLong(map, listingLocation);

        infowindow = new google.maps.InfoWindow();


        let service = new google.maps.places.PlacesService(map);
        service.nearbySearch({
            location: listingLocation,
            radius: 500,
            type: ['restaurant']
        }, callback);
    }

    function initStreetView() {
        panorama = new google.maps.StreetViewPanorama(
            document.getElementById('street-view-container'),
            {
                position: {lat: <%= @listing.latitude %>, lng: <%= @listing.longitude %>},
                pov: {heading: 60, pitch: 0},
                zoom: 1
            });

        $("body").on("shown.bs.tab", "#street_view_tab", function () {
            google.maps.event.trigger(panorama, 'resize');
        });
    }

    function callback(results, status) {
        $("#restaurant-count").text(results.length);
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            for (let i = 0; i < results.length; i++) {
                //createMarker(results[i]);
                $("#restaurant-list").append(place.name);
            }
        }
    }

    function createMarker(place) {
        let placeLoc = place.geometry.location;
        let marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location
        });

        google.maps.event.addListener(marker, 'click', function() {
            infowindow.setContent(place.name);
            infowindow.open(map, this);
        });
    }

    function createMarkerFromLatLong(map, latLong) {
        console.log(map);
        console.log(latLong);
        let marker = new google.maps.Marker({
            map: map,
            position: latLong
        });

        google.maps.event.addListener(marker, 'click', function() {
            infowindow.setContent("<%= @listing.listing_name %>");
            infowindow.open(map, this);
        });
    }
</script>

<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrRvrsJS76i6RqSHHJif6wlq1cY93Ynm0&libraries=places&callback=initMap">
</script>